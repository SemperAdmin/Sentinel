name: Update Portfolio Overview

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-overview:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate overview JSON
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PORTFOLIO_PAT || secrets.GITHUB_TOKEN }}
          script: |
            const owner = 'SemperAdmin';
            const repoList = [];
            let page = 1;
            while (true) {
              const { data } = await github.request('GET /users/{username}/repos', {
                username: owner,
                per_page: 100,
                sort: 'updated',
                direction: 'desc',
                page
              });
              if (!data || data.length === 0) break;
              repoList.push(...data);
              page++;
            }

            const sanitizeId = (name) => name.toLowerCase().replace(/[^a-z0-9]/g, '-');
            const sleep = (ms) => new Promise(r => setTimeout(r, ms));

            const overview = [];
            for (let i = 0; i < repoList.length; i++) {
              const r = repoList[i];
              if (r.private || r.name === 'eventcall-images') continue;
              const id = sanitizeId(r.name);
              let lastCommitDate = r.pushed_at || r.updated_at;
              try {
                const { data: commits } = await github.request('GET /repos/{owner}/{repo}/commits', {
                  owner,
                  repo: r.name,
                  per_page: 1
                });
                if (Array.isArray(commits) && commits[0]?.commit?.author?.date) {
                  lastCommitDate = commits[0].commit.author.date;
                }
              } catch (e) {}

              let recentViews = 0;
              try {
                const { data: views } = await github.request('GET /repos/{owner}/{repo}/traffic/views', {
                  owner,
                  repo: r.name,
                  per: 'day'
                });
                recentViews = views?.count || 0;
              } catch (e) {}

              const nextReviewDate = (() => {
                const d = new Date(lastCommitDate || Date.now());
                d.setDate(d.getDate() + 90);
                return d.toISOString().split('T')[0];
              })();

              overview.push({
                id,
                repoUrl: r.html_url,
                platform: 'Web',
                status: 'Active',
                lastReviewDate: null,
                nextReviewDate,
                pendingTodos: 0,
                notes: r.description || 'No description available',
                lastCommitDate,
                latestTag: null,
                stars: r.stargazers_count,
                language: r.language,
                isPrivate: r.private,
                archived: r.archived,
                recentViews
              });

              if (i % 5 === 4) await sleep(1000);
            }

            const toPretty = (arr) => JSON.stringify(arr, null, 2) + "\n";

            const path = 'data/portfolio/overview.json';
            let currentSha = null;
            try {
              const { data: existing } = await github.request('GET /repos/{owner}/{repo}/contents/{path}', {
                owner,
                repo: 'Sentinel',
                path,
                ref: 'main'
              });
              currentSha = existing.sha;
              const content = Buffer.from(existing.content, 'base64').toString('utf-8');
              const current = JSON.parse(content);
              const next = JSON.parse(toPretty(overview));
              const unchanged = JSON.stringify(current) === JSON.stringify(next);
              if (unchanged) {
                core.info('Overview unchanged; skipping commit');
                return;
              }
            } catch (e) {}

            const content = Buffer.from(toPretty(overview)).toString('base64');
            await github.request('PUT /repos/{owner}/{repo}/contents/{path}', {
              owner,
              repo: 'Sentinel',
              path,
              message: 'Update portfolio overview JSON',
              content,
              branch: 'main',
              sha: currentSha || undefined
            });